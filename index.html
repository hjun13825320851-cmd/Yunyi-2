<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>è·¨å¢ƒè¿è¥çµåŠ¨ä»ªè¡¨ç›˜ v5.2.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --bg: #f3f4f6; --card-white: #ffffff; --text-title: #1f2937; --text-body: #4b5563;
        }
        body { margin: 0; padding: 25px; font-family: 'Montserrat', 'Microsoft YaHei', sans-serif; background-color: var(--bg); color: var(--text-body); min-width: 1200px; }
        .container { max-width: 1450px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* æ—¶é’Ÿ */
        .world-clocks { display: flex; gap: 15px; padding: 15px 25px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); justify-content: space-between; align-items: center; }
        .clock-item { display: flex; align-items: center; gap: 10px; padding-right: 20px; border-right: 1px solid rgba(255,255,255,0.1); }
        .clock-item:last-child { border: none; padding-right: 0; }
        .flag { font-size: 22px; }
        .clock-info { display: flex; flex-direction: column; }
        .clock-label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .clock-time { font-size: 18px; color: #38bdf8; font-weight: 700; font-family: 'Montserrat', monospace; }

        /* å¡ç‰‡ */
        .card { background: var(--card-white); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .card-header { padding: 15px 25px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 12px 12px 0 0; }
        .card-title { font-size: 15px; font-weight: 700; color: var(--text-title); display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 25px; }

        /* è¾“å…¥æ§ä»¶ */
        .input-group { display: grid; grid-template-columns: 2fr 1fr 1fr 120px; gap: 20px; align-items: flex-end; }
        .field-label { font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; outline: none; transition: 0.2s; background: #f9fafb; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* åˆ©æ¶¦é¢æ¿ */
        .metrics-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; background: #f8fafc; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #e5e7eb; }
        .metric-item { text-align: center; border-right: 1px solid #e5e7eb; padding: 0 10px; }
        .metric-item:last-child { border: none; }
        .metric-input-box { background: #fff !important; border: 1px solid #d1d5db !important; text-align: center; font-size: 18px !important; font-weight: 700 !important; color: var(--text-title); }
        .metric-val { font-size: 24px; font-weight: 800; display: block; margin-top: 5px; color: var(--text-title); }

        /* ä»»åŠ¡çœ‹æ¿ */
        .work-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .task-list-container { height: 320px; overflow-y: auto; padding-right: 5px; }
        .task-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e5e7eb; transition: 0.2s; }
        .task-item:hover { border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .task-item.done span { text-decoration: line-through; color: #9ca3af; }
        .task-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; border-color: #cbd5e1; }

        /* SKU é›·è¾¾ */
        .sku-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .sku-table th { background: #f9fafb; padding: 12px; text-align: left; color: #6b7280; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        .sku-table td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-late { background: #fee2e2; color: #991b1b; animation: blink 2s infinite; }
        .status-wait { background: #f3f4f6; color: #9ca3af; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* FB å¹¿å‘Š */
        .fb-header { display: grid; grid-template-columns: 80px 1fr 1.5fr 1fr 1fr 1fr 60px; gap: 15px; padding: 10px 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 12px; font-weight: 700; color: #6b7280; }
        .fb-row { display: grid; grid-template-columns: 80px 1fr 1.5fr 1fr 1fr 1fr 60px; gap: 15px; padding: 15px 20px; border-bottom: 1px solid #f3f4f6; align-items: center; transition: 0.2s; }
        .fb-row:hover { background: #fdfbfc; }
        .fb-img-box { width: 60px; height: 60px; background: #e5e7eb; border-radius: 6px; cursor: pointer; overflow: hidden; position: relative; border: 1px solid #d1d5db; }
        .fb-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .fb-img-box:hover::after { content: 'æ›´æ¢'; position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; }

        /* å”®åè¡¨æ ¼ */
        .issue-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .issue-table th { text-align: left; padding: 12px 15px; font-size: 12px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; color: #6b7280; }
        .issue-table td { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        .textarea-pro { min-height: 70px; height: 70px; resize: vertical; padding: 8px; font-size: 13px; line-height: 1.5; }

        /* æŒ‰é’®ä¸é€šç”¨ */
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border: none; font-size: 13px; transition: 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-ghost { background: white; color: #6b7280; border: 1px solid #d1d5db; }
        .btn-ghost:hover { border-color: var(--danger); color: var(--danger); }
        .btn-mini { padding: 4px 8px; font-size: 11px; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #fff; border: 1px solid #e5e7eb; padding: 4px 10px; border-radius: 15px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: #4b5563; }
        .tag.active { background: var(--primary); color: white; border-color: var(--primary); }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1f2937; color: #fff; padding: 12px 24px; border-radius: 8px; display: none; z-index: 9999; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* v5.2.2 - åˆ©æ¶¦å¼¹çª—ï¼ˆç”µè„‘æ ·å¼ï¼‰ */
        .profit-fab {
            position: fixed;
            left: 22px;
            bottom: 22px;
            width: 84px;
            height: 84px;
            border-radius: 18px;
            background: #111827;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 12px 28px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            transition: transform .15s ease;
        }
        .profit-fab:hover { transform: translateY(-2px); }
        .profit-fab .pc {
            width: 54px; height: 44px; position: relative;
        }
        .profit-fab .pc::before{
            content:"";
            position:absolute;
            left:0; top:0;
            width:54px; height:34px;
            border-radius: 6px;
            background: linear-gradient(135deg, #1f2937 0%, #0b1220 100%);
            border: 1px solid rgba(56,189,248,0.35);
            box-shadow: inset 0 0 0 2px rgba(79,70,229,0.18);
        }
        .profit-fab .pc::after{
            content:"";
            position:absolute;
            left: 11px; top: 36px;
            width: 32px; height: 8px;
            border-radius: 0 0 8px 8px;
            background: #374151;
            border: 1px solid rgba(255,255,255,0.10);
        }
        .profit-fab .dot{
            position:absolute; left: 24px; top: 14px;
            width:6px;height:6px;border-radius:999px;background:#38bdf8;
            box-shadow: 0 0 0 6px rgba(56,189,248,0.12);
        }

        .modal-mask{
            position: fixed; inset: 0;
            background: rgba(15,23,42,0.55);
            display:none;
            z-index: 9998;
        }
        .modal{
            position: fixed;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            width: 920px;
            max-width: calc(100vw - 60px);
            background: #fff;
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 30px 60px rgba(0,0,0,0.25);
            display:none;
            z-index: 9999;
            overflow: hidden;
        }
        .modal-header{
            padding: 14px 18px;
            display:flex; align-items:center; justify-content:space-between;
            background: #fff;
            border-bottom: 1px solid #f3f4f6;
        }
        .modal-title{
            font-weight: 800;
            color: var(--text-title);
            display:flex; align-items:center; gap:10px;
        }
        .modal-body{ padding: 18px; background: #fafafa; }
        .modal-close{
            border: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 8px;
            width: 34px; height: 34px;
            cursor:pointer;
        }
        .modal-grid{
            display:grid;
            grid-template-columns: 1.2fr 1fr 1fr 1fr;
            gap: 12px;
        }
        .modal-grid .box{
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
        }
        .modal-grid .k{ font-size: 12px; font-weight: 800; color: #9ca3af; }
        .modal-grid .v{ margin-top: 6px; font-size: 16px; font-weight: 800; color: var(--text-title); }
        .modal-grid .v small{ font-weight: 700; color: #6b7280; }
        .modal-grid .span-2{ grid-column: span 2; }
        .modal-grid .span-4{ grid-column: span 4; }

        /* æ¨¡æ¿ä¸‹è½½æŒ‰é’® */
        .template-actions{ display:flex; gap:10px; flex-wrap:wrap; }
        .btn-secondary{ background:#0f172a; color:#fff; }
        .btn-secondary:hover{ background:#111c33; }
    </style>
</head>
<body>

<div class="container">

    <div class="world-clocks" id="clockBar">
        <div class="clock-item"><span class="flag">ğŸ‡¨ğŸ‡³</span><div class="clock-info"><span class="clock-label">åŒ—äº¬æ—¶é—´</span><span class="clock-time" id="time-bj">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡ºğŸ‡¸</span><div class="clock-info"><span class="clock-label">æ´›æ‰çŸ¶</span><span class="clock-time" id="time-la">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡¬ğŸ‡§</span><div class="clock-info"><span class="clock-label">ä¼¦æ•¦</span><span class="clock-time" id="time-uk">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡¨ğŸ‡¿</span><div class="clock-info"><span class="clock-label">å¸ƒæ‹‰æ ¼</span><span class="clock-time" id="time-cz">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡¦ğŸ‡º</span><div class="clock-info"><span class="clock-label">æ‚‰å°¼</span><span class="clock-time" id="time-au">00:00:00</span></div></div>
    </div>

    <header style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: var(--primary); color:white; width:42px; height:42px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px;">
                <i class="fa-solid fa-chart-simple"></i>
            </div>
            <div>
                <h1 style="margin:0; font-size:18px; color: var(--text-title); font-weight: 800;">è·¨å¢ƒè¿è¥çµåŠ¨å·¥ä½œå° <span style="font-weight:400; opacity:0.6; font-size:14px;">v5.2.2</span></h1>
                <p style="margin:0; font-size:12px; color:var(--text-body);">å®æ—¶æ±‡ç‡ (USD/CNY): <strong id="rateLabel" style="color:var(--primary)">7.1200</strong></p>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-ghost" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> å¯¼å‡ºExcel</button>
            <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()"><i class="fa-solid fa-upload"></i> æ¢å¤æ•°æ®</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            <button class="btn btn-ghost" style="color:var(--danger); border-color:#fecaca;" onclick="clearEverything()"><i class="fa-solid fa-trash"></i> æ ¼å¼åŒ–</button>
        </div>
    </header>

    <div class="work-grid">
        <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-solid fa-star"></i> é‡ç‚¹ä»»åŠ¡</div></div>
            <div class="card-body">
                <div id="todoList" class="task-list-container"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addTask('todo')">+ æ·»åŠ ä»»åŠ¡</button>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-regular fa-clock"></i> ä»Šæ—¥æ—¥ç¨‹</div></div>
            <div class="card-body">
                <div id="scheduleList" class="task-list-container"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addTask('schedule')">+ å®‰æ’æ—¶æ®µ</button>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-solid fa-rotate"></i> æ—¥å¸¸å›ºå®š (æ¯æ—¥é‡ç½®)</div></div>
            <div class="card-body">
                <div id="dailyList" class="task-list-container"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addTask('daily')">+ å¢åŠ å›ºå®šé¡¹</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-headset"></i> å”®åå¤„ç†ä¸­å¿ƒ</div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <div class="template-actions">
                    <button class="btn btn-ghost btn-mini" onclick="downloadTemplate('after_sales')"><i class="fa-solid fa-download"></i> å”®åå¯¼å…¥æ¨¡æ¿</button>
                </div>
                <select id="issueSort" onchange="loadIssues()" style="padding:6px; border-radius:4px; border:6px solid #d1d5db;">
                    <option value="date-desc">æ—¥æœŸï¼šä»æ–°åˆ°æ—§</option>
                    <option value="days-desc">å¤©æ•°ï¼šä»å¤šåˆ°å°‘</option>
                </select>
                <input type="text" id="issueSearch" placeholder="æœç´¢è®¢å•..." oninput="filterIssues()" style="width:150px; padding:6px;">
                <button class="btn btn-primary" onclick="addIssueRow()">æ–°å¢è®°å½•</button>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="issue-table">
                <thead>
                    <tr>
                        <th style="width:120px; padding-left:20px;">ç™»è®°æ—¥æœŸ</th>
                        <th style="width:80px; text-align:center;">å·²è¿‡å¤©æ•°</th>
                        <th style="width:150px;">è®¢å•ç¼–å·</th>
                        <th>å¼‚å¸¸è¯¦æƒ…</th>
                        <th>è¿›åº¦åŠ¨ä½œ</th>
                        <th style="width:110px;">çŠ¶æ€</th>
                        <th style="width:50px;"></th>
                    </tr>
                </thead>
                <tbody id="issueBody"></tbody>
            </table>
        </div>
    </div>

    <!-- v5.2.2: åˆ©æ¶¦å³æ—¶åˆ†ææ”¹ä¸ºå¼¹çª— + å·¦ä¸‹è§’ç”µè„‘æŒ‰é’®ï¼ˆåŸå¡ç‰‡ä¿ç•™ä½†éšè—ï¼Œé¿å…ç ´ååŸç»“æ„/é€»è¾‘ï¼‰ -->
    <div class="card" id="profitCard" style="display:none;">
        <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-calculator"></i> åˆ©æ¶¦å³æ—¶åˆ†æ</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-ghost" onclick="resetAnalysisInputs()">æ¸…ç©ºè¾“å…¥</button>
                <button class="btn btn-primary" onclick="saveCurrentProduct()">å­˜æ¡£è®°å¿†</button>
            </div>
        </div>
        <div class="card-body"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-plane-departure"></i> SKU ç‰©æµé›·è¾¾ (åˆ°ä»“æé†’)</div>
            <div class="template-actions">
                <button class="btn btn-ghost btn-mini" onclick="downloadTemplate('sku_radar')"><i class="fa-solid fa-download"></i> SKUé›·è¾¾æ¨¡æ¿</button>
                <button class="btn btn-primary btn-mini" onclick="addSKULogix()">+ æ–°å¢ç›‘æ§</button>
            </div>
        </div>
        <div class="card-body" style="padding:0">
            <table class="sku-table">
                <thead>
                    <tr>
                        <th style="width:25%">SKU åç§°</th>
                        <th style="width:15%">å‘è´§æ—¥æœŸ</th>
                        <th style="width:15%">é¢„è®¡æ—¶æ•ˆ (å¤©)</th>
                        <th style="width:15%">é¢„è®¡åˆ°ä»“æ—¥</th>
                        <th style="width:20%">çŠ¶æ€æé†’</th>
                        <th style="width:10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="skuBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-brands fa-facebook-f"></i> Facebook å¹¿å‘Šè¡¨ç°ç›‘æ§</div>
            <div class="template-actions">
                <button class="btn btn-ghost btn-mini" onclick="downloadTemplate('fb_ads')"><i class="fa-solid fa-download"></i> FBå¹¿å‘Šæ¨¡æ¿</button>
                <button class="btn btn-primary btn-mini" onclick="addFBRow()">+ æ–°å¢å¸–å­</button>
            </div>
        </div>
        <div class="card-body" style="padding:0">
            <div class="fb-header">
                <div>é¢„è§ˆå›¾</div>
                <div>å¹¿å‘Šåç§°</div> <div>å¸–å­ç¼–ç </div>
                <div><i class="fa-solid fa-heart" style="color:#f91880"></i> å¿ƒæƒ…æ•°</div>
                <div><i class="fa-solid fa-comment" style="color:#4f46e5"></i> è¯„è®ºæ•°</div>
                <div><i class="fa-solid fa-thumbs-up" style="color:#1877f2"></i> ç‚¹èµæ•°</div>
                <div>æ“ä½œ</div>
            </div>
            <div id="fbContainer"></div>
        </div>
    </div>

</div>

<div id="toast" class="toast"></div>

<!-- v5.2.2: å·¦ä¸‹è§’â€œç”µè„‘â€æŒ‰é’® -->
<div class="profit-fab" onclick="openProfitModal()" title="åˆ©æ¶¦å³æ—¶åˆ†æ">
    <div class="pc"><span class="dot"></span></div>
</div>

<!-- v5.2.2: å¼¹çª— -->
<div id="profitMask" class="modal-mask" onclick="closeProfitModal()"></div>
<div id="profitModal" class="modal" role="dialog" aria-modal="true" aria-label="åˆ©æ¶¦å³æ—¶åˆ†æ">
    <div class="modal-header">
        <div class="modal-title"><i class="fa-solid fa-calculator"></i> åˆ©æ¶¦å³æ—¶åˆ†æ</div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-ghost btn-mini" onclick="resetAnalysisInputs()">æ¸…ç©ºè¾“å…¥</button>
            <button class="btn btn-primary btn-mini" onclick="saveCurrentProduct()">å­˜æ¡£è®°å¿†</button>
            <button class="modal-close" onclick="closeProfitModal()" aria-label="å…³é—­"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>
    <div class="modal-body">
        <div class="input-group" style="margin-bottom: 12px;">
            <div><label class="field-label">å•†å“åç§° / SKU</label><input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šè“ç‰™è€³æœº-é»‘è‰²" oninput="calculate()"></div>
            <div><label class="field-label">ç«å“å”®ä»· ($)</label><input type="number" id="offPrice" step="0.01" oninput="calculate()"></div>
            <div><label class="field-label">æˆ‘å¸å”®ä»· ($)</label><input type="number" id="myPrice" step="0.01" oninput="calculate()"></div>
            <div><label class="field-label">ä»·æ ¼ç«äº‰åŠ›</label><div id="compBadge" style="padding:10px; border-radius:6px; font-weight:700; text-align:center; background:#f3f4f6; font-size:12px;">å¾…è¾“å…¥</div></div>
        </div>

        <div class="tag-list" id="tagCloud"></div>

        <div class="modal-grid" style="margin-top: 12px;">
            <div class="box span-2">
                <div class="k">é‡‡è´­æˆæœ¬ (Â¥)</div>
                <div class="v"><input type="number" id="costCNY" oninput="calculate()" class="metric-input-box" placeholder="0" style="font-size:16px!important;"></div>
            </div>
            <div class="box span-2">
                <div class="k">å¤´ç¨‹è¿è´¹ (Â¥)</div>
                <div class="v"><input type="number" id="shipCNY" oninput="calculate()" class="metric-input-box" placeholder="0" style="font-size:16px!important;"></div>
            </div>

            <div class="box">
                <div class="k">æ€»æˆæœ¬ï¼ˆ$ï¼‰</div>
                <div class="v" id="resTotalCost">$ 0.00</div>
            </div>
            <div class="box">
                <div class="k">å•å“æ¯›åˆ©ï¼ˆï¿¥/$ï¼‰</div>
                <div class="v" id="resProfitDual">Â¥ 0.00 / $ 0.00</div>
            </div>
            <div class="box">
                <div class="k">å‡€åˆ©ç‡</div>
                <div class="v" id="resMargin">0.00%</div>
            </div>
            <div class="box">
                <div class="k">å»ºè®®å”®ä»· (30%åˆ©)</div>
                <div class="v" id="resRec">$ 0.00</div>
            </div>

            <div class="box span-4">
                <div class="k">å¿«é€Ÿç»“æœ</div>
                <div class="v" style="display:flex; gap:18px; flex-wrap:wrap;">
                    <span><small style="color:#6b7280;font-weight:800;">å•†å“åç§° / SKUï¼š</small><span id="resName" style="font-weight:900;">--</span></span>
                    <span><small style="color:#6b7280;font-weight:800;">ç«å“å”®ä»· ($)ï¼š</small><span id="resOff">$ 0.00</span></span>
                    <span><small style="color:#6b7280;font-weight:800;">æˆ‘å¸å”®ä»· ($)ï¼š</small><span id="resMy">$ 0.00</span></span>
                    <span><small style="color:#6b7280;font-weight:800;">ä»·æ ¼ç«äº‰åŠ›ï¼š</small><span id="resComp">--</span></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let globalRate = 7.12;

    // v5.2.2: ç»Ÿä¸€è®°å¿†å­˜å‚¨å±‚ï¼ˆè·¨ç‰ˆæœ¬è¿ç§»ï¼‰
    const STORE = {
        ver: '5.2.2',
        tasks: 'lm_mem_tasks',          // {todo:[],schedule:[],daily:[], last_reset:''}
        issues: 'lm_mem_issues',        // []
        sku: 'lm_mem_sku',              // []
        fb: 'lm_mem_fb',                // []
        profitList: 'lm_mem_profit_list', // []
        profitPrefix: 'lm_mem_profit_'  // + name
    };

    window.onload = () => {
        startClocks();
        fetchRate();
        migrateMemory();
        loadHistory();
        loadIssues();
        loadWorkTasks();
        loadFBTable();
        loadSKULogix();
        checkDailyReset();
    };

    // ------------------ v5.2.2 æ–°å¢ï¼šæ¨¡æ¿ä¸‹è½½ï¼ˆCSVï¼ŒExcelå¯ç›´æ¥æ‰“å¼€ï¼‰ ------------------
    function downloadTemplate(type){
        const bom = "\uFEFF";
        let name = "æ¨¡æ¿";
        let csv = "";

        if(type === 'fb_ads'){
            name = "Facebookå¹¿å‘Šè¡¨ç°ç›‘æ§_å¯¼å…¥æ¨¡æ¿";
            csv = [
                "å¹¿å‘Šåç§°,å¸–å­ç¼–ç ,å¿ƒæƒ…æ•°,è¯„è®ºæ•°,ç‚¹èµæ•°,é¢„è§ˆå›¾(base64å¯ç•™ç©º)",
                "ç¤ºä¾‹å¹¿å‘ŠA,POST-001,12,3,28,",
                "ç¤ºä¾‹å¹¿å‘ŠB,POST-002,5,1,9,"
            ].join("\n");
        } else if(type === 'sku_radar'){
            name = "SKUç‰©æµé›·è¾¾_å¯¼å…¥æ¨¡æ¿";
            csv = [
                "SKU åç§°,å‘è´§æ—¥æœŸ(YYYY-MM-DD),é¢„è®¡æ—¶æ•ˆ(å¤©)",
                "SKU-ç¤ºä¾‹A,2026-01-15,15",
                "SKU-ç¤ºä¾‹B,2026-01-20,20"
            ].join("\n");
        } else if(type === 'profit'){
            name = "åˆ©æ¶¦å³æ—¶åˆ†æ_å¯¼å…¥æ¨¡æ¿";
            csv = [
                "å•†å“åç§° / SKU,ç«å“å”®ä»· ($),æˆ‘å¸å”®ä»· ($),é‡‡è´­æˆæœ¬ (Â¥),å¤´ç¨‹è¿è´¹ (Â¥)",
                "è“ç‰™è€³æœº-é»‘è‰²,29.99,27.99,38,12"
            ].join("\n");
        } else if(type === 'after_sales'){
            name = "å”®åå¤„ç†ä¸­å¿ƒ_å¯¼å…¥æ¨¡æ¿";
            csv = [
                "ç™»è®°æ—¥æœŸ(YYYY-MM-DD),è®¢å•ç¼–å·,å¼‚å¸¸è¯¦æƒ…,è¿›åº¦åŠ¨ä½œ,çŠ¶æ€(pending/solved)",
                "2026-02-01,ORDER-001,åŒ…è£¹æœªåˆ°,å·²è”ç³»æ‰¿è¿å•†,pending"
            ].join("\n");
        } else {
            return;
        }

        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `${name}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("æ¨¡æ¿å·²ä¸‹è½½ï¼ˆCSVï¼‰");
    }

    // ------------------ å¯¼å‡ºï¼šä¿ç•™åŸæŒ‰é’®è¡Œä¸ºï¼ˆå”®åCSVï¼‰ ------------------
    function exportToExcel() {
        let csvContent = "\uFEFF";
        csvContent += "ç™»è®°æ—¥æœŸ,å·²è¿‡å¤©æ•°,è®¢å•ç¼–å·,å¼‚å¸¸è¯¦æƒ…,è¿›åº¦åŠ¨ä½œ,çŠ¶æ€\n";

        let data = JSON.parse(localStorage.getItem(STORE.issues) || '[]');
        data.forEach(row => {
            const days = getDaysElapsed(row.date);
            const clean = (text) => `"${(text || '').replace(/"/g, '""')}"`;
            csvContent += `${clean(row.date)},${days},${clean(row.order)},${clean(row.issue)},${clean(row.process)},${clean(row.status === 'solved' ? 'å·²ç»“æ¡ˆ' : 'å¤„ç†ä¸­')}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `å”®åè®°å½•å¤‡ä»½_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel (CSV) æ–‡ä»¶å·²ä¸‹è½½");
    }

    // ------------------ v5.2.2ï¼šè·¨ç‰ˆæœ¬è¿ç§»ï¼ˆç¡®ä¿ç‰ˆæœ¬è¿­ä»£ä»è®°ä½æ—§å†…å®¹ï¼‰ ------------------
    function migrateMemory(){
        // 1) tasksï¼šä»æ—§ work_* è¿ç§»
        const curTasks = JSON.parse(localStorage.getItem(STORE.tasks) || 'null');
        if(!curTasks){
            const todo = JSON.parse(localStorage.getItem('work_todo') || '[]');
            const schedule = JSON.parse(localStorage.getItem('work_schedule') || '[]');
            const daily = JSON.parse(localStorage.getItem('work_daily') || '[]');
            localStorage.setItem(STORE.tasks, JSON.stringify({todo, schedule, daily, last_reset: localStorage.getItem('last_reset') || ''}));
        }

        // 2) issuesï¼šä» issue_db_v4 è¿ç§»ï¼ˆå¹¶ä¿®å¤å¯¼å…¥/å­˜å‚¨ä¸å…¨çš„é—®é¢˜ï¼šç»Ÿä¸€å­—æ®µï¼‰
        const curIssues = localStorage.getItem(STORE.issues);
        if(!curIssues){
            const old = JSON.parse(localStorage.getItem('issue_db_v4') || '[]');
            const fixed = old.map(r => ({
                date: r.date || new Date().toISOString().split('T')[0],
                order: r.order || '',
                issue: r.issue || '',
                process: r.process || '',
                status: r.status === 'solved' ? 'solved' : 'pending'
            }));
            localStorage.setItem(STORE.issues, JSON.stringify(fixed));
        }

        // 3) skuï¼šä» sku_radar è¿ç§»
        const curSku = localStorage.getItem(STORE.sku);
        if(!curSku){
            const old = JSON.parse(localStorage.getItem('sku_radar') || '[]');
            localStorage.setItem(STORE.sku, JSON.stringify(old));
        }

        // 4) fbï¼šä» fb_ads_v52 è¿ç§»
        const curFb = localStorage.getItem(STORE.fb);
        if(!curFb){
            const old = JSON.parse(localStorage.getItem('fb_ads_v52') || '[]');
            localStorage.setItem(STORE.fb, JSON.stringify(old));
        }

        // 5) profitï¼šä» p_v51_* è¿ç§»ï¼ˆåˆ—è¡¨+æ˜ç»†ï¼‰
        const curProfitList = localStorage.getItem(STORE.profitList);
        if(!curProfitList){
            const oldList = JSON.parse(localStorage.getItem('p_v51_list') || '[]');
            localStorage.setItem(STORE.profitList, JSON.stringify(oldList));
            oldList.forEach(n => {
                const d = JSON.parse(localStorage.getItem('p_v51_' + n) || 'null');
                if(d && !localStorage.getItem(STORE.profitPrefix + n)){
                    localStorage.setItem(STORE.profitPrefix + n, JSON.stringify(d));
                }
            });
        }
    }

    // ------------------ æ—¶é’Ÿ / æ±‡ç‡ ------------------
    function startClocks() {
        const update = () => {
            const zones = [{id:'bj',z:'Asia/Shanghai'},{id:'la',z:'America/Los_Angeles'},{id:'uk',z:'Europe/London'},{id:'cz',z:'Europe/Prague'},{id:'au',z:'Australia/Sydney'}];
            zones.forEach(z => {
                const now = new Date();
                document.getElementById(`time-${z.id}`).innerText = now.toLocaleTimeString('en-GB', {timeZone: z.z, hour12: false});
            });
        };
        update(); setInterval(update, 1000);
    }

    async function fetchRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            if(data?.rates?.CNY) {
                globalRate = data.rates.CNY;
                document.getElementById('rateLabel').innerText = globalRate.toFixed(4);
                calculate();
            }
        } catch(e) {}
    }

    // ------------------ v5.2.2ï¼šåˆ©æ¶¦å¼¹çª—æ§åˆ¶ ------------------
    function openProfitModal(){
        document.getElementById('profitMask').style.display = 'block';
        document.getElementById('profitModal').style.display = 'block';
        calculate();
    }
    function closeProfitModal(){
        document.getElementById('profitMask').style.display = 'none';
        document.getElementById('profitModal').style.display = 'none';
    }

    // ------------------ v5.2.2ï¼šåˆ©æ¶¦è®¡ç®—ï¼ˆè¡¥å……æ€»æˆæœ¬/åŒå¸æ¯›åˆ©/å¼¹çª—å­—æ®µï¼‰ ------------------
    function calculate() {
        const name = (document.getElementById('itemName')?.value || '').trim();
        const off = parseFloat(document.getElementById('offPrice')?.value) || 0;
        const my = parseFloat(document.getElementById('myPrice')?.value) || 0;
        const cost = parseFloat(document.getElementById('costCNY')?.value) || 0;
        const ship = parseFloat(document.getElementById('shipCNY')?.value) || 0;

        const badge = document.getElementById('compBadge');
        let compText = '--';
        if(badge){
            if(off && my) {
                if(my < off) { compText = "ä»·æ ¼ä¼˜åŠ¿"; badge.innerHTML = compText; badge.style.color = "#fff"; badge.style.background = "var(--success)"; }
                else if(my == off) { compText = "ä»·æ ¼æŒå¹³"; badge.innerHTML = compText; badge.style.color = "#fff"; badge.style.background = "var(--warning)"; }
                else { compText = "ä»·æ ¼åŠ£åŠ¿"; badge.innerHTML = compText; badge.style.color = "#fff"; badge.style.background = "var(--danger)"; }
            } else {
                badge.innerHTML = "å¾…è¾“å…¥"; badge.style.color = "#111827"; badge.style.background = "#f3f4f6";
            }
        }

        // åŸé€»è¾‘ï¼šè®¢å•é¢å¤–è´¹ç”¨ / æ‰‹ç»­è´¹
        const totalPaid = my + (my > 0 && my < 35 ? 10 : 0);
        const totalCostUSD = (cost + ship) / globalRate + (totalPaid * 0.04);
        const profitUSD = totalPaid - totalCostUSD;
        const margin = totalPaid > 0 ? (profitUSD / totalPaid) * 100 : 0;
        const rec = ((cost + ship) / globalRate) / 0.66;

        // è¾“å‡ºåˆ°å¼¹çª—
        const resTotalCost = document.getElementById('resTotalCost');
        const resProfitDual = document.getElementById('resProfitDual');
        const resMargin = document.getElementById('resMargin');
        const resRec = document.getElementById('resRec');

        if(resTotalCost) resTotalCost.innerText = `$ ${my > 0 ? totalCostUSD.toFixed(2) : "0.00"}`;

        // åŒå¸æ¯›åˆ©ï¼šÂ¥ / $
        const profitCNY = profitUSD * globalRate;
        if(resProfitDual) resProfitDual.innerText = `Â¥ ${my > 0 ? profitCNY.toFixed(2) : "0.00"} / $ ${my > 0 ? profitUSD.toFixed(2) : "0.00"}`;

        if(resMargin){
            resMargin.innerText = margin.toFixed(2) + "%";
            resMargin.style.color = margin >= 30 ? "var(--success)" : "var(--danger)";
        }
        if(resRec) resRec.innerText = `$ ${my > 0 ? rec.toFixed(2) : "0.00"}`;

        // å¿«é€Ÿç»“æœåŒº
        const resName = document.getElementById('resName');
        const resOff = document.getElementById('resOff');
        const resMy = document.getElementById('resMy');
        const resComp = document.getElementById('resComp');
        if(resName) resName.innerText = name || '--';
        if(resOff) resOff.innerText = `$ ${off ? off.toFixed(2) : "0.00"}`;
        if(resMy) resMy.innerText = `$ ${my ? my.toFixed(2) : "0.00"}`;
        if(resComp) resComp.innerText = compText;
    }

    // ------------------ SKU ç‰©æµé›·è¾¾ï¼ˆä½¿ç”¨ç»Ÿä¸€è®°å¿†é”®ï¼‰ ------------------
    function loadSKULogix() {
        const list = JSON.parse(localStorage.getItem(STORE.sku) || '[]');
        const container = document.getElementById('skuBody');
        container.innerHTML = '';
        list.forEach((item, index) => {
            const arrDate = item.shipDate ? new Date(new Date(item.shipDate).getTime() + (parseInt(item.duration||0) * 86400000)) : null;
            const today = new Date(); today.setHours(0,0,0,0);
            const isLate = arrDate ? (today > arrDate) : false;

            let statusHtml = '<span class="status-tag status-wait">å¾…å¡«å†™</span>';
            if(item.name && item.shipDate) {
                statusHtml = isLate
                    ? '<span class="status-tag status-late">âš  å·²é€¾æœŸ</span>'
                    : '<span class="status-tag status-ok">ğŸŸ¢ è¿è¾“ä¸­</span>';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${escapeHtml(item.name||'')}" oninput="upSKU(${index},'name',this.value)"></td>
                <td><input type="date" value="${escapeAttr(item.shipDate||'')}" onchange="upSKU(${index},'shipDate',this.value)"></td>
                <td><input type="number" value="${escapeAttr(item.duration||15)}" oninput="upSKU(${index},'duration',this.value)"></td>
                <td style="font-weight:700">${arrDate ? arrDate.toLocaleDateString() : '--'}</td>
                <td>${statusHtml}</td>
                <td><button class="btn-ghost" style="color:var(--danger);padding:4px;" onclick="delSKU(${index})"><i class="fa-solid fa-trash"></i></button></td>
            `;
            container.appendChild(tr);
        });
    }
    function addSKULogix() {
        let list = JSON.parse(localStorage.getItem(STORE.sku)||'[]');
        list.push({name:'', shipDate:'', duration:15});
        localStorage.setItem(STORE.sku,JSON.stringify(list)); loadSKULogix();
    }
    function upSKU(i,f,v) { let l=JSON.parse(localStorage.getItem(STORE.sku)); l[i][f]=v; localStorage.setItem(STORE.sku,JSON.stringify(l)); loadSKULogix(); }
    function delSKU(i) { let l=JSON.parse(localStorage.getItem(STORE.sku)); l.splice(i,1); localStorage.setItem(STORE.sku,JSON.stringify(l)); loadSKULogix(); }

    // ------------------ FB å¹¿å‘Šï¼ˆä½¿ç”¨ç»Ÿä¸€è®°å¿†é”®ï¼‰ ------------------
    function loadFBTable() {
        const list = JSON.parse(localStorage.getItem(STORE.fb) || '[]');
        const container = document.getElementById('fbContainer');
        container.innerHTML = '';
        list.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'fb-row';
            div.innerHTML = `
                <div class="fb-img-box" onclick="document.getElementById('fbFile${index}').click()">
                    <img src="${item.img || ''}">
                    <input type="file" id="fbFile${index}" style="display:none" onchange="handleFBImg(${index}, event)">
                </div>
                <input type="text" value="${escapeAttr(item.adName || '')}" placeholder="å¹¿å‘Šåç§°" oninput="upFB(${index},'adName',this.value)">
                <input type="text" value="${escapeAttr(item.code || '')}" placeholder="ç¼–ç " oninput="upFB(${index},'code',this.value)">
                <input type="number" value="${escapeAttr(item.heart ?? 0)}" oninput="upFB(${index},'heart',this.value)">
                <input type="number" value="${escapeAttr(item.comm ?? 0)}" oninput="upFB(${index},'comm',this.value)">
                <input type="number" value="${escapeAttr(item.like ?? 0)}" oninput="upFB(${index},'like',this.value)">
                <button class="btn-ghost" onclick="delFB(${index})"><i class="fa-solid fa-trash"></i></button>
            `;
            container.appendChild(div);
        });
    }
    function addFBRow() { let l=JSON.parse(localStorage.getItem(STORE.fb)||'[]'); l.push({img:'', adName:'', code:'', heart:0, comm:0, like:0}); localStorage.setItem(STORE.fb,JSON.stringify(l)); loadFBTable(); }
    function upFB(i,f,v) { let l=JSON.parse(localStorage.getItem(STORE.fb)); l[i][f]=v; localStorage.setItem(STORE.fb,JSON.stringify(l)); }
    function delFB(i) { let l=JSON.parse(localStorage.getItem(STORE.fb)); l.splice(i,1); localStorage.setItem(STORE.fb,JSON.stringify(l)); loadFBTable(); }
    function handleFBImg(i,ev) { const f=ev.target.files[0]; const r=new FileReader(); r.onload=e=>{upFB(i,'img',e.target.result);loadFBTable()}; r.readAsDataURL(f); }

    // ------------------ ä»»åŠ¡é€»è¾‘ï¼ˆä½¿ç”¨ç»Ÿä¸€è®°å¿†é”®ï¼›ç‰ˆæœ¬æ›´æ–°ä¸ä¸¢ï¼‰ ------------------
    function checkDailyReset() {
        const today = new Date().toLocaleDateString();
        const state = JSON.parse(localStorage.getItem(STORE.tasks) || '{"todo":[],"schedule":[],"daily":[],"last_reset":""}');
        if (state.last_reset !== today) {
            state.daily = (state.daily || []).map(i => ({...i, done:false}));
            state.last_reset = today;
            localStorage.setItem(STORE.tasks, JSON.stringify(state));
        }
    }

    function loadWorkTasks() {
        const state = JSON.parse(localStorage.getItem(STORE.tasks) || '{"todo":[],"schedule":[],"daily":[]}');
        ['todo', 'schedule', 'daily'].forEach(type => {
            const list = state[type] || [];
            const el = document.getElementById(`${type}List`);
            el.innerHTML = '';
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `task-item ${item.done ? 'done' : ''}`;
                div.innerHTML = `<input type="checkbox" ${item.done ? 'checked' : ''} onchange="togTask('${type}',${index})"><span contenteditable="true" onblur="editTask('${type}',${index},this)">${escapeHtml(item.text||'')}</span><i class="fa-solid fa-xmark" style="margin-left:auto;cursor:pointer;opacity:0.3" onclick="delTask('${type}',${index})"></i>`;
                el.appendChild(div);
            });
        });
    }
    function addTask(t) {
        const state = JSON.parse(localStorage.getItem(STORE.tasks) || '{"todo":[],"schedule":[],"daily":[]}');
        state[t] = state[t] || [];
        state[t].push({text:'æ–°äº‹é¡¹',done:false});
        localStorage.setItem(STORE.tasks, JSON.stringify(state));
        loadWorkTasks();
    }
    function togTask(t,i) {
        const state = JSON.parse(localStorage.getItem(STORE.tasks));
        state[t][i].done = !state[t][i].done;
        localStorage.setItem(STORE.tasks, JSON.stringify(state));
        loadWorkTasks();
    }
    function editTask(t,i,el) {
        const state = JSON.parse(localStorage.getItem(STORE.tasks));
        state[t][i].text = el.innerText;
        localStorage.setItem(STORE.tasks, JSON.stringify(state));
    }
    function delTask(t,i) {
        const state = JSON.parse(localStorage.getItem(STORE.tasks));
        state[t].splice(i,1);
        localStorage.setItem(STORE.tasks, JSON.stringify(state));
        loadWorkTasks();
    }

    // ------------------ å”®åï¼šä¿®å¤â€œExcelå¯¼å…¥æ•°æ®ä¸å…¨â€æ ¹å› ï¼ˆpersist è¯»å–æ›´ç¨³ï¼‰ ------------------
    function addIssueRow() {
        let d = JSON.parse(localStorage.getItem(STORE.issues)||'[]');
        d.unshift({ date: new Date().toISOString().split('T')[0], order: '', issue: '', process: '', status: 'pending' });
        localStorage.setItem(STORE.issues, JSON.stringify(d)); loadIssues();
    }

    function loadIssues() {
        let d = JSON.parse(localStorage.getItem(STORE.issues)||'[]');
        const sort = document.getElementById('issueSort').value;
        d.sort((a,b) => sort==='days-desc' ? new Date(a.date)-new Date(b.date) : new Date(b.date)-new Date(a.date));
        const body = document.getElementById('issueBody'); body.innerHTML='';
        d.forEach(i => {
            const tr = document.createElement('tr');
            const days = getDaysElapsed(i.date);
            tr.innerHTML = `
                <td style="padding-left:20px"><input type="date" value="${escapeAttr(i.date)}" onchange="persistIssues()"></td>
                <td style="text-align:center;font-weight:bold;color:${days>3?'var(--danger)':'var(--warning)'}">${days}å¤©</td>
                <td><input type="text" value="${escapeAttr(i.order||'')}" placeholder="è®¢å•å·" oninput="persistIssues()"></td>
                <td><textarea class="textarea-pro" oninput="persistIssues()">${escapeHtml(i.issue||'')}</textarea></td>
                <td><textarea class="textarea-pro" oninput="persistIssues()">${escapeHtml(i.process||'')}</textarea></td>
                <td>
                    <select onchange="persistIssues()">
                        <option value="pending" ${i.status==='pending'?'selected':''}>å¤„ç†ä¸­</option>
                        <option value="solved" ${i.status==='solved'?'selected':''}>å·²ç»“æ¡ˆ</option>
                    </select>
                </td>
                <td style="text-align:center"><button class="btn-ghost" onclick="this.closest('tr').remove();persistIssues()"><i class="fa-solid fa-trash"></i></button></td>
            `;
            body.appendChild(tr);
        });
    }

    // ä¿®å¤ç‚¹ï¼šDOM é€‰æ‹©æ›´ä¸¥æ ¼ + å­—æ®µå…œåº•ï¼Œé¿å…â€œå¯¼å…¥åä¸ºç©º/ç¼ºåˆ—å¯¼è‡´å­˜å‚¨ä¸å…¨â€
    function persistIssues() {
        const rows = Array.from(document.querySelectorAll('#issueBody tr')).map(r => {
            const dateEl = r.querySelector('input[type="date"]');
            const orderEl = r.querySelector('input[type="text"]');
            const textareas = r.querySelectorAll('textarea');
            const sel = r.querySelector('select');

            return {
                date: (dateEl && dateEl.value) ? dateEl.value : new Date().toISOString().split('T')[0],
                order: (orderEl && orderEl.value) ? orderEl.value : '',
                issue: (textareas[0] && textareas[0].value) ? textareas[0].value : '',
                process: (textareas[1] && textareas[1].value) ? textareas[1].value : '',
                status: (sel && sel.value) ? sel.value : 'pending'
            };
        });
        localStorage.setItem(STORE.issues, JSON.stringify(rows));
    }

    function filterIssues() {
        const k = document.getElementById('issueSearch').value.toLowerCase();
        document.querySelectorAll('#issueBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(k) ? '' : 'none');
    }
    function getDaysElapsed(d) {
        const s=new Date(d), n=new Date();
        return Math.floor((Date.UTC(n.getFullYear(), n.getMonth(), n.getDate()) - Date.UTC(s.getFullYear(), s.getMonth(), s.getDate()))/(1000*60*60*24));
    }

    // ------------------ åˆ©æ¶¦å­˜æ¡£è®°å¿†ï¼ˆä½¿ç”¨ç»Ÿä¸€è®°å¿†é”®ï¼›ç‰ˆæœ¬æ›´æ–°ä¸ä¸¢ï¼‰ ------------------
    function saveCurrentProduct() {
        const n = (document.getElementById('itemName').value || '').trim();
        if(!n) return showToast("è¯·è¾“å…¥å•†å“å");

        const d = {
            off: document.getElementById('offPrice').value,
            my: document.getElementById('myPrice').value,
            cost: document.getElementById('costCNY').value,
            ship: document.getElementById('shipCNY').value
        };
        localStorage.setItem(STORE.profitPrefix + n, JSON.stringify(d));

        let l = JSON.parse(localStorage.getItem(STORE.profitList) || '[]');
        if(!l.includes(n)) { l.unshift(n); localStorage.setItem(STORE.profitList, JSON.stringify(l)); }
        loadHistory();
        showToast("å·²å­˜æ¡£");
    }

    function loadHistory() {
        const c = document.getElementById('tagCloud');
        const l = JSON.parse(localStorage.getItem(STORE.profitList) || '[]');
        c.innerHTML = l.length ? '' : '<span style="font-size:12px;color:#ccc">æš‚æ— å­˜æ¡£</span>';
        l.forEach(n => {
            const t = document.createElement('div');
            t.className = 'tag';
            t.innerHTML = `<span>${escapeHtml(n)}</span><i class="fa-solid fa-xmark" onclick="delHist('${escapeJs(n)}',event)" style="font-size:10px;opacity:0.5"></i>`;
            t.onclick = () => {
                const d = JSON.parse(localStorage.getItem(STORE.profitPrefix + n) || 'null');
                if(d) {
                    document.getElementById('itemName').value=n;
                    document.getElementById('offPrice').value=d.off;
                    document.getElementById('myPrice').value=d.my;
                    document.getElementById('costCNY').value=d.cost;
                    document.getElementById('shipCNY').value=d.ship;
                    calculate();
                    openProfitModal();
                }
            };
            c.appendChild(t);
        });
    }

    function delHist(n,e) {
        e.stopPropagation();
        let l = JSON.parse(localStorage.getItem(STORE.profitList) || '[]').filter(i => i !== n);
        localStorage.setItem(STORE.profitList, JSON.stringify(l));
        localStorage.removeItem(STORE.profitPrefix + n);
        loadHistory();
    }

    function resetAnalysisInputs() {
        ['itemName','offPrice','myPrice','costCNY','shipCNY'].forEach(i=>{ const el=document.getElementById(i); if(el) el.value=''; });
        calculate();
    }

    // ------------------ å¤‡ä»½/æ¢å¤/æ¸…ç©ºï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰ ------------------
    function importData(ev) {
        const f=ev.target.files[0];
        const r=new FileReader();
        r.onload=e=>{
            const d=JSON.parse(e.target.result);
            Object.keys(d).forEach(k=>localStorage.setItem(k,d[k]));
            location.reload();
        };
        r.readAsText(f);
    }

    function clearEverything() {
        if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.reload(); }
    }

    function showToast(m) {
        const t=document.getElementById('toast');
        t.innerText=m;
        t.style.display='block';
        setTimeout(()=>t.style.display='none',2000);
    }

    // ------------------ å®‰å…¨è½¬ä¹‰å°å·¥å…· ------------------
    function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(s){
        return String(s).replace(/"/g,'&quot;');
    }
    function escapeJs(s){
        return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    }
</script>
</body>
</html>
