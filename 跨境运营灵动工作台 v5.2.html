<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>è·¨å¢ƒè¿è¥çµåŠ¨ä»ªè¡¨ç›˜ v5.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --bg: #f3f4f6; --card-white: #ffffff; --text-title: #1f2937; --text-body: #4b5563;
        }
        body { margin: 0; padding: 25px; font-family: 'Montserrat', 'Microsoft YaHei', sans-serif; background-color: var(--bg); color: var(--text-body); min-width: 1200px; }
        .container { max-width: 1450px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* æ—¶é’Ÿ */
        .world-clocks { display: flex; gap: 15px; padding: 15px 25px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); justify-content: space-between; align-items: center; }
        .clock-item { display: flex; align-items: center; gap: 10px; padding-right: 20px; border-right: 1px solid rgba(255,255,255,0.1); }
        .clock-item:last-child { border: none; padding-right: 0; }
        .flag { font-size: 22px; }
        .clock-info { display: flex; flex-direction: column; }
        .clock-label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .clock-time { font-size: 18px; color: #38bdf8; font-weight: 700; font-family: 'Montserrat', monospace; }

        /* å¡ç‰‡ */
        .card { background: var(--card-white); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .card-header { padding: 15px 25px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 12px 12px 0 0; }
        .card-title { font-size: 15px; font-weight: 700; color: var(--text-title); display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 25px; }

        /* è¾“å…¥æ§ä»¶ */
        .input-group { display: grid; grid-template-columns: 2fr 1fr 1fr 120px; gap: 20px; align-items: flex-end; }
        .field-label { font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; outline: none; transition: 0.2s; background: #f9fafb; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* åˆ©æ¶¦é¢æ¿ */
        .metrics-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; background: #f8fafc; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #e5e7eb; }
        .metric-item { text-align: center; border-right: 1px solid #e5e7eb; padding: 0 10px; }
        .metric-item:last-child { border: none; }
        .metric-input-box { background: #fff !important; border: 1px solid #d1d5db !important; text-align: center; font-size: 18px !important; font-weight: 700 !important; color: var(--text-title); }
        .metric-val { font-size: 24px; font-weight: 800; display: block; margin-top: 5px; color: var(--text-title); }

        /* ä»»åŠ¡çœ‹æ¿ */
        .work-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .task-list-container { height: 320px; overflow-y: auto; padding-right: 5px; }
        .task-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e5e7eb; transition: 0.2s; }
        .task-item:hover { border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .task-item.done span { text-decoration: line-through; color: #9ca3af; }
        .task-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; border-color: #cbd5e1; }

        /* SKU é›·è¾¾ */
        .sku-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .sku-table th { background: #f9fafb; padding: 12px; text-align: left; color: #6b7280; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        .sku-table td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 12px; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-late { background: #fee2e2; color: #991b1b; animation: blink 2s infinite; }
        .status-wait { background: #f3f4f6; color: #9ca3af; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* FB å¹¿å‘Š (æ–°å¢åç§°åˆ—) */
        .fb-header { display: grid; grid-template-columns: 80px 1fr 1.5fr 1fr 1fr 1fr 60px; gap: 15px; padding: 10px 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 12px; font-weight: 700; color: #6b7280; }
        .fb-row { display: grid; grid-template-columns: 80px 1fr 1.5fr 1fr 1fr 1fr 60px; gap: 15px; padding: 15px 20px; border-bottom: 1px solid #f3f4f6; align-items: center; transition: 0.2s; }
        .fb-row:hover { background: #fdfbfc; }
        .fb-img-box { width: 60px; height: 60px; background: #e5e7eb; border-radius: 6px; cursor: pointer; overflow: hidden; position: relative; border: 1px solid #d1d5db; }
        .fb-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .fb-img-box:hover::after { content: 'æ›´æ¢'; position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; }

        /* å”®åè¡¨æ ¼ */
        .issue-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .issue-table th { text-align: left; padding: 12px 15px; font-size: 12px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; color: #6b7280; }
        .issue-table td { padding: 10px 15px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        .textarea-pro { min-height: 70px; height: 70px; resize: vertical; padding: 8px; font-size: 13px; line-height: 1.5; }

        /* æŒ‰é’®ä¸é€šç”¨ */
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border: none; font-size: 13px; transition: 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-ghost { background: white; color: #6b7280; border: 1px solid #d1d5db; }
        .btn-ghost:hover { border-color: var(--danger); color: var(--danger); }
        .btn-mini { padding: 4px 8px; font-size: 11px; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #fff; border: 1px solid #e5e7eb; padding: 4px 10px; border-radius: 15px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: #4b5563; }
        .tag.active { background: var(--primary); color: white; border-color: var(--primary); }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1f2937; color: #fff; padding: 12px 24px; border-radius: 8px; display: none; z-index: 9999; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="world-clocks" id="clockBar">
        <div class="clock-item"><span class="flag">ğŸ‡¨ğŸ‡³</span><div class="clock-info"><span class="clock-label">åŒ—äº¬æ—¶é—´</span><span class="clock-time" id="time-bj">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡ºğŸ‡¸</span><div class="clock-info"><span class="clock-label">æ´›æ‰çŸ¶</span><span class="clock-time" id="time-la">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡¬ğŸ‡§</span><div class="clock-info"><span class="clock-label">ä¼¦æ•¦</span><span class="clock-time" id="time-uk">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡¨ğŸ‡¿</span><div class="clock-info"><span class="clock-label">å¸ƒæ‹‰æ ¼</span><span class="clock-time" id="time-cz">00:00:00</span></div></div>
        <div class="clock-item"><span class="flag">ğŸ‡¦ğŸ‡º</span><div class="clock-info"><span class="clock-label">æ‚‰å°¼</span><span class="clock-time" id="time-au">00:00:00</span></div></div>
    </div>

    <header style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: var(--primary); color:white; width:42px; height:42px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px;">
                <i class="fa-solid fa-chart-simple"></i>
            </div>
            <div>
                <h1 style="margin:0; font-size:18px; color: var(--text-title); font-weight: 800;">è·¨å¢ƒè¿è¥çµåŠ¨å·¥ä½œå° <span style="font-weight:400; opacity:0.6; font-size:14px;">v5.2</span></h1>
                <p style="margin:0; font-size:12px; color:var(--text-body);">å®æ—¶æ±‡ç‡ (USD/CNY): <strong id="rateLabel" style="color:var(--primary)">7.1200</strong></p>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-ghost" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> å¯¼å‡ºExcel</button>
            <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()"><i class="fa-solid fa-upload"></i> æ¢å¤æ•°æ®</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            <button class="btn btn-ghost" style="color:var(--danger); border-color:#fecaca;" onclick="clearEverything()"><i class="fa-solid fa-trash"></i> æ ¼å¼åŒ–</button>
        </div>
    </header>

    <div class="work-grid">
        <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-solid fa-star"></i> é‡ç‚¹ä»»åŠ¡</div></div>
            <div class="card-body">
                <div id="todoList" class="task-list-container"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addTask('todo')">+ æ·»åŠ ä»»åŠ¡</button>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-regular fa-clock"></i> ä»Šæ—¥æ—¥ç¨‹</div></div>
            <div class="card-body">
                <div id="scheduleList" class="task-list-container"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addTask('schedule')">+ å®‰æ’æ—¶æ®µ</button>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title"><i class="fa-solid fa-rotate"></i> æ—¥å¸¸ä»»åŠ¡ </div></div>
            <div class="card-body">
                <div id="dailyList" class="task-list-container"></div>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addTask('daily')">+ å¢åŠ å›ºå®šé¡¹</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-headset"></i> å”®åå¤„ç†ä¸­å¿ƒ</div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <select id="issueSort" onchange="loadIssues()" style="padding:6px; border-radius:4px; border:1px solid #d1d5db;">
                    <option value="date-desc">æ—¥æœŸï¼šä»æ–°åˆ°æ—§</option>
                    <option value="days-desc">å¤©æ•°ï¼šä»å¤šåˆ°å°‘</option>
                </select>
                <input type="text" id="issueSearch" placeholder="æœç´¢è®¢å•..." oninput="filterIssues()" style="width:150px; padding:6px;">
                <button class="btn btn-primary" onclick="addIssueRow()">æ–°å¢è®°å½•</button>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="issue-table">
                <thead>
                    <tr>
                        <th style="width:120px; padding-left:20px;">ç™»è®°æ—¥æœŸ</th>
                        <th style="width:80px; text-align:center;">å·²è¿‡å¤©æ•°</th>
                        <th style="width:150px;">è®¢å•ç¼–å·</th>
                        <th>å¼‚å¸¸è¯¦æƒ…</th>
                        <th>è¿›åº¦åŠ¨ä½œ</th>
                        <th style="width:110px;">çŠ¶æ€</th>
                        <th style="width:50px;"></th>
                    </tr>
                </thead>
                <tbody id="issueBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-calculator"></i> åˆ©æ¶¦å³æ—¶åˆ†æ</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-ghost" onclick="resetAnalysisInputs()">æ¸…ç©ºè¾“å…¥</button>
                <button class="btn btn-primary" onclick="saveCurrentProduct()">å­˜æ¡£è®°å¿†</button>
            </div>
        </div>
        <div class="card-body">
            <div class="input-group">
                <div><label class="field-label">å•†å“åç§° / SKU</label><input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šè“ç‰™è€³æœº-é»‘è‰²"></div>
                <div><label class="field-label">ç«å“å”®ä»· ($)</label><input type="number" id="offPrice" step="0.01" oninput="calculate()"></div>
                <div><label class="field-label">æˆ‘å¸å”®ä»· ($)</label><input type="number" id="myPrice" step="0.01" oninput="calculate()"></div>
                <div><label class="field-label">ä»·æ ¼ç«äº‰åŠ›</label><div id="compBadge" style="padding:10px; border-radius:6px; font-weight:700; text-align:center; background:#f3f4f6; font-size:12px;">å¾…è¾“å…¥</div></div>
            </div>
            <div class="tag-list" id="tagCloud"></div>
            <div class="metrics-grid">
                <div class="metric-item"><label class="field-label">é‡‡è´­æˆæœ¬ (Â¥)</label><input type="number" id="costCNY" oninput="calculate()" class="metric-input-box" placeholder="0"></div>
                <div class="metric-item"><label class="field-label">å¤´ç¨‹è¿è´¹ (Â¥)</label><input type="number" id="shipCNY" oninput="calculate()" class="metric-input-box" placeholder="0"></div>
                <div class="metric-item"><label class="field-label">å•å“æ¯›åˆ©</label><span class="metric-val" id="resProfit" style="color:var(--primary);">$ 0.00</span></div>
                <div class="metric-item"><label class="field-label">å»ºè®®å”®ä»· (30%åˆ©)</label><span class="metric-val" id="resRec" style="color:var(--success);">$ 0.00</span></div>
                <div class="metric-item"><label class="field-label">å‡€åˆ©ç‡</label><span class="metric-val" id="resMargin">0.00%</span></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-solid fa-plane-departure"></i> SKU ç‰©æµé›·è¾¾ (åˆ°ä»“æé†’)</div>
            <button class="btn btn-primary btn-mini" onclick="addSKULogix()">+ æ–°å¢ç›‘æ§</button>
        </div>
        <div class="card-body" style="padding:0">
            <table class="sku-table">
                <thead>
                    <tr>
                        <th style="width:25%">SKU åç§°</th>
                        <th style="width:15%">å‘è´§æ—¥æœŸ</th>
                        <th style="width:15%">é¢„è®¡æ—¶æ•ˆ (å¤©)</th>
                        <th style="width:15%">é¢„è®¡åˆ°ä»“æ—¥</th>
                        <th style="width:20%">çŠ¶æ€æé†’</th>
                        <th style="width:10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="skuBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title"><i class="fa-brands fa-facebook-f"></i> Facebook å¹¿å‘Šè¡¨ç°ç›‘æ§</div>
            <button class="btn btn-primary btn-mini" onclick="addFBRow()">+ æ–°å¢å¸–å­</button>
        </div>
        <div class="card-body" style="padding:0">
            <div class="fb-header">
                <div>é¢„è§ˆå›¾</div>
                <div>å¹¿å‘Šåç§°</div> <div>å¸–å­ç¼–ç </div>
                <div><i class="fa-solid fa-heart" style="color:#f91880"></i> å¿ƒæƒ…æ•°</div>
                <div><i class="fa-solid fa-comment" style="color:#4f46e5"></i> è¯„è®ºæ•°</div>
                <div><i class="fa-solid fa-thumbs-up" style="color:#1877f2"></i> ç‚¹èµæ•°</div>
                <div>æ“ä½œ</div>
            </div>
            <div id="fbContainer"></div>
        </div>
    </div>

</div>

<div id="toast" class="toast"></div>

<script>
    let globalRate = 7.12;

    window.onload = () => {
        startClocks();
        fetchRate();
        loadHistory();
        loadIssues();
        loadWorkTasks();
        loadFBTable();
        loadSKULogix();
        checkDailyReset();
    };

    // --- å¯¼å‡º Excel åŠŸèƒ½ (æ–°å¢) ---
    function exportToExcel() {
        // æ„å»º CSV å†…å®¹ (BOMå¤´è§£å†³ä¸­æ–‡ä¹±ç )
        let csvContent = "\uFEFF";
        // è¡¨å¤´
        csvContent += "ç™»è®°æ—¥æœŸ,å·²è¿‡å¤©æ•°,è®¢å•ç¼–å·,å¼‚å¸¸è¯¦æƒ…,è¿›åº¦åŠ¨ä½œ,çŠ¶æ€\n";
        
        let data = JSON.parse(localStorage.getItem('issue_db_v4') || '[]');
        data.forEach(row => {
            const days = getDaysElapsed(row.date);
            // å¤„ç†å†…å®¹ä¸­çš„é€—å·å’Œæ¢è¡Œç¬¦ï¼Œé˜²æ­¢ç ´å CSV æ ¼å¼
            const clean = (text) => `"${(text || '').replace(/"/g, '""')}"`;
            csvContent += `${clean(row.date)},${days},${clean(row.order)},${clean(row.issue)},${clean(row.process)},${clean(row.status === 'solved' ? 'å·²ç»“æ¡ˆ' : 'å¤„ç†ä¸­')}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `å”®åè®°å½•å¤‡ä»½_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel (CSV) æ–‡ä»¶å·²ä¸‹è½½");
    }

    // --- å…¶ä»–åŸæœ‰é€»è¾‘ ---
    function startClocks() {
        const update = () => {
            const zones = [{id:'bj',z:'Asia/Shanghai'},{id:'la',z:'America/Los_Angeles'},{id:'uk',z:'Europe/London'},{id:'cz',z:'Europe/Prague'},{id:'au',z:'Australia/Sydney'}];
            zones.forEach(z => {
                const now = new Date();
                document.getElementById(`time-${z.id}`).innerText = now.toLocaleTimeString('en-GB', {timeZone: z.z, hour12: false});
            });
        };
        update(); setInterval(update, 1000);
    }

    async function fetchRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            if(data?.rates?.CNY) { globalRate = data.rates.CNY; document.getElementById('rateLabel').innerText = globalRate.toFixed(4); calculate(); }
        } catch(e) {}
    }

    function calculate() {
        const off = parseFloat(document.getElementById('offPrice').value) || 0;
        const my = parseFloat(document.getElementById('myPrice').value) || 0;
        const cost = parseFloat(document.getElementById('costCNY').value) || 0;
        const ship = parseFloat(document.getElementById('shipCNY').value) || 0;
        
        const badge = document.getElementById('compBadge');
        if(off && my) {
            if(my < off) { badge.innerHTML = "ä»·æ ¼ä¼˜åŠ¿"; badge.style.color = "#fff"; badge.style.background = "var(--success)"; }
            else if(my == off) { badge.innerHTML = "ä»·æ ¼æŒå¹³"; badge.style.color = "#fff"; badge.style.background = "var(--warning)"; }
            else { badge.innerHTML = "ä»·æ ¼åŠ£åŠ¿"; badge.style.color = "#fff"; badge.style.background = "var(--danger)"; }
        }

        const totalPaid = my + (my > 0 && my < 35 ? 10 : 0);
        const totalCostUSD = (cost + ship) / globalRate + (totalPaid * 0.04);
        const profit = totalPaid - totalCostUSD;
        const margin = totalPaid > 0 ? (profit / totalPaid) * 100 : 0;
        const rec = ((cost + ship) / globalRate) / 0.66;

        document.getElementById('resProfit').innerText = `$ ${my > 0 ? profit.toFixed(2) : "0.00"}`;
        document.getElementById('resMargin').innerText = margin.toFixed(2) + "%";
        document.getElementById('resMargin').style.color = margin >= 30 ? "var(--success)" : "var(--danger)";
        document.getElementById('resRec').innerText = `$ ${my > 0 ? rec.toFixed(2) : "0.00"}`;
    }

    // --- SKU ç‰©æµé›·è¾¾ (ä¿®å¤çŠ¶æ€é€»è¾‘) ---
    function loadSKULogix() {
        const list = JSON.parse(localStorage.getItem('sku_radar') || '[]');
        const container = document.getElementById('skuBody');
        container.innerHTML = '';
        list.forEach((item, index) => {
            const arrDate = new Date(new Date(item.shipDate).getTime() + item.duration * 86400000);
            const today = new Date(); today.setHours(0,0,0,0);
            const isLate = today > arrDate;
            
            // çŠ¶æ€é€»è¾‘åˆ¤æ–­
            let statusHtml = '<span class="status-tag status-wait">å¾…å¡«å†™</span>';
            if(item.name && item.shipDate) {
                statusHtml = isLate 
                    ? '<span class="status-tag status-late">âš  å·²é€¾æœŸ</span>' 
                    : '<span class="status-tag status-ok">ğŸŸ¢ è¿è¾“ä¸­</span>';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${item.name}" oninput="upSKU(${index},'name',this.value)"></td>
                <td><input type="date" value="${item.shipDate}" onchange="upSKU(${index},'shipDate',this.value)"></td>
                <td><input type="number" value="${item.duration}" oninput="upSKU(${index},'duration',this.value)"></td>
                <td style="font-weight:700">${item.shipDate ? arrDate.toLocaleDateString() : '--'}</td>
                <td>${statusHtml}</td>
                <td><button class="btn-ghost" style="color:var(--danger);padding:4px;" onclick="delSKU(${index})"><i class="fa-solid fa-trash"></i></button></td>
            `;
            container.appendChild(tr);
        });
    }
    function addSKULogix() {
        let list = JSON.parse(localStorage.getItem('sku_radar')||'[]');
        list.push({name:'', shipDate:'', duration:15});
        localStorage.setItem('sku_radar',JSON.stringify(list)); loadSKULogix();
    }
    function upSKU(i,f,v) { let l=JSON.parse(localStorage.getItem('sku_radar')); l[i][f]=v; localStorage.setItem('sku_radar',JSON.stringify(l)); loadSKULogix(); }
    function delSKU(i) { let l=JSON.parse(localStorage.getItem('sku_radar')); l.splice(i,1); localStorage.setItem('sku_radar',JSON.stringify(l)); loadSKULogix(); }

    // --- FB å¹¿å‘Š (æ–°å¢åç§°) ---
    function loadFBTable() {
        const list = JSON.parse(localStorage.getItem('fb_ads_v52') || '[]');
        const container = document.getElementById('fbContainer');
        container.innerHTML = '';
        list.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'fb-row';
            div.innerHTML = `
                <div class="fb-img-box" onclick="document.getElementById('fbFile${index}').click()">
                    <img src="${item.img || ''}">
                    <input type="file" id="fbFile${index}" style="display:none" onchange="handleFBImg(${index}, event)">
                </div>
                <input type="text" value="${item.adName || ''}" placeholder="å¹¿å‘Šåç§°" oninput="upFB(${index},'adName',this.value)">
                <input type="text" value="${item.code}" placeholder="ç¼–ç " oninput="upFB(${index},'code',this.value)">
                <input type="number" value="${item.heart}" oninput="upFB(${index},'heart',this.value)">
                <input type="number" value="${item.comm}" oninput="upFB(${index},'comm',this.value)">
                <input type="number" value="${item.like}" oninput="upFB(${index},'like',this.value)">
                <button class="btn-ghost" onclick="delFB(${index})"><i class="fa-solid fa-trash"></i></button>
            `;
            container.appendChild(div);
        });
    }
    function addFBRow() { let l=JSON.parse(localStorage.getItem('fb_ads_v52')||'[]'); l.push({img:'', adName:'', code:'', heart:0, comm:0, like:0}); localStorage.setItem('fb_ads_v52',JSON.stringify(l)); loadFBTable(); }
    function upFB(i,f,v) { let l=JSON.parse(localStorage.getItem('fb_ads_v52')); l[i][f]=v; localStorage.setItem('fb_ads_v52',JSON.stringify(l)); }
    function delFB(i) { let l=JSON.parse(localStorage.getItem('fb_ads_v52')); l.splice(i,1); localStorage.setItem('fb_ads_v52',JSON.stringify(l)); loadFBTable(); }
    function handleFBImg(i,ev) { const f=ev.target.files[0]; const r=new FileReader(); r.onload=e=>{upFB(i,'img',e.target.result);loadFBTable()}; r.readAsDataURL(f); }

    // --- ä»»åŠ¡é€»è¾‘ ---
    function checkDailyReset() {
        const today = new Date().toLocaleDateString();
        if (localStorage.getItem('last_reset') !== today) {
            let l = JSON.parse(localStorage.getItem('work_daily')||'[]');
            l.forEach(i => i.done = false);
            localStorage.setItem('work_daily', JSON.stringify(l));
            localStorage.setItem('last_reset', today);
        }
    }
    function loadWorkTasks() {
        ['todo', 'schedule', 'daily'].forEach(type => {
            const list = JSON.parse(localStorage.getItem(`work_${type}`) || '[]');
            const el = document.getElementById(`${type}List`);
            el.innerHTML = '';
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `task-item ${item.done ? 'done' : ''}`;
                div.innerHTML = `<input type="checkbox" ${item.done ? 'checked' : ''} onchange="togTask('${type}',${index})"><span contenteditable="true" onblur="editTask('${type}',${index},this)">${item.text}</span><i class="fa-solid fa-xmark" style="margin-left:auto;cursor:pointer;opacity:0.3" onclick="delTask('${type}',${index})"></i>`;
                el.appendChild(div);
            });
        });
    }
    function addTask(t) { let l=JSON.parse(localStorage.getItem(`work_${t}`)||'[]'); l.push({text:'æ–°äº‹é¡¹',done:false}); localStorage.setItem(`work_${t}`,JSON.stringify(l)); loadWorkTasks(); }
    function togTask(t,i) { let l=JSON.parse(localStorage.getItem(`work_${t}`)); l[i].done=!l[i].done; localStorage.setItem(`work_${t}`,JSON.stringify(l)); loadWorkTasks(); }
    function editTask(t,i,el) { let l=JSON.parse(localStorage.getItem(`work_${t}`)); l[i].text=el.innerText; localStorage.setItem(`work_${t}`,JSON.stringify(l)); }
    function delTask(t,i) { let l=JSON.parse(localStorage.getItem(`work_${t}`)); l.splice(i,1); localStorage.setItem(`work_${t}`,JSON.stringify(l)); loadWorkTasks(); }

    // --- å”®å & é€šç”¨ ---
    function saveCurrentProduct() {
        const n = document.getElementById('itemName').value.trim();
        if(!n) return showToast("è¯·è¾“å…¥å•†å“å");
        const d = { off: document.getElementById('offPrice').value, my: document.getElementById('myPrice').value, cost: document.getElementById('costCNY').value, ship: document.getElementById('shipCNY').value };
        localStorage.setItem('p_v51_' + n, JSON.stringify(d));
        let l = JSON.parse(localStorage.getItem('p_v51_list') || '[]');
        if(!l.includes(n)) { l.unshift(n); localStorage.setItem('p_v51_list', JSON.stringify(l)); }
        loadHistory(); showToast("å·²å­˜æ¡£");
    }
    function loadHistory() {
        const c = document.getElementById('tagCloud');
        const l = JSON.parse(localStorage.getItem('p_v51_list') || '[]');
        c.innerHTML = l.length ? '' : '<span style="font-size:12px;color:#ccc">æš‚æ— å­˜æ¡£</span>';
        l.forEach(n => {
            const t = document.createElement('div'); t.className = 'tag'; t.innerHTML = `<span>${n}</span><i class="fa-solid fa-xmark" onclick="delHist('${n}',event)" style="font-size:10px;opacity:0.5"></i>`;
            t.onclick = () => {
                const d = JSON.parse(localStorage.getItem('p_v51_' + n));
                if(d) { document.getElementById('itemName').value=n; document.getElementById('offPrice').value=d.off; document.getElementById('myPrice').value=d.my; document.getElementById('costCNY').value=d.cost; document.getElementById('shipCNY').value=d.ship; calculate(); }
            }; c.appendChild(t);
        });
    }
    function delHist(n,e) { e.stopPropagation(); let l = JSON.parse(localStorage.getItem('p_v51_list')).filter(i => i !== n); localStorage.setItem('p_v51_list', JSON.stringify(l)); localStorage.removeItem('p_v51_' + n); loadHistory(); }
    
    function addIssueRow() {
        let d = JSON.parse(localStorage.getItem('issue_db_v4')||'[]');
        d.unshift({ date: new Date().toISOString().split('T')[0], order: '', issue: '', process: '', status: 'pending' });
        localStorage.setItem('issue_db_v4', JSON.stringify(d)); loadIssues();
    }
    function loadIssues() {
        let d = JSON.parse(localStorage.getItem('issue_db_v4')||'[]');
        const sort = document.getElementById('issueSort').value;
        d.sort((a,b) => sort==='days-desc' ? new Date(a.date)-new Date(b.date) : new Date(b.date)-new Date(a.date));
        const body = document.getElementById('issueBody'); body.innerHTML='';
        d.forEach(i => {
            const tr = document.createElement('tr');
            const days = getDaysElapsed(i.date);
            tr.innerHTML = `
                <td style="padding-left:20px"><input type="date" value="${i.date}" onchange="persistIssues()"></td>
                <td style="text-align:center;font-weight:bold;color:${days>3?'var(--danger)':'var(--warning)'}">${days}å¤©</td>
                <td><input type="text" value="${i.order}" placeholder="è®¢å•å·" oninput="persistIssues()"></td>
                <td><textarea class="textarea-pro" oninput="persistIssues()">${i.issue}</textarea></td>
                <td><textarea class="textarea-pro" oninput="persistIssues()">${i.process}</textarea></td>
                <td><select onchange="persistIssues()"><option value="pending" ${i.status==='pending'?'selected':''}>å¤„ç†ä¸­</option><option value="solved" ${i.status==='solved'?'selected':''}>å·²ç»“æ¡ˆ</option></select></td>
                <td style="text-align:center"><button class="btn-ghost" onclick="this.closest('tr').remove();persistIssues()"><i class="fa-solid fa-trash"></i></button></td>
            `;
            body.appendChild(tr);
        });
    }
    function persistIssues() {
        const rows = Array.from(document.querySelectorAll('#issueBody tr')).map(r => ({
            date: r.querySelector('input[type="date"]').value, order: r.querySelector('input[type="text"]').value,
            issue: r.querySelectorAll('textarea')[0].value, process: r.querySelectorAll('textarea')[1].value, status: r.querySelector('select').value
        }));
        localStorage.setItem('issue_db_v4', JSON.stringify(rows));
    }
    function filterIssues() { const k = document.getElementById('issueSearch').value.toLowerCase(); document.querySelectorAll('#issueBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(k) ? '' : 'none'); }
    function getDaysElapsed(d) { const s=new Date(d), n=new Date(); return Math.floor((Date.UTC(n.getFullYear(), n.getMonth(), n.getDate()) - Date.UTC(s.getFullYear(), s.getMonth(), s.getDate()))/(1000*60*60*24)); }

    function resetAnalysisInputs() { ['itemName','offPrice','myPrice','costCNY','shipCNY'].forEach(i=>document.getElementById(i).value=''); calculate(); }
    function importData(ev) { const f=ev.target.files[0]; const r=new FileReader(); r.onload=e=>{ const d=JSON.parse(e.target.result); Object.keys(d).forEach(k=>localStorage.setItem(k,d[k])); location.reload(); }; r.readAsText(f); }
    function clearEverything() { if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
</script>
</body>
</html>